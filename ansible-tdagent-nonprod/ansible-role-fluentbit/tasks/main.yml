---
# tasks file for ansible-role-fluentbit

- name: Install Fluentbit
  include_tasks: 'install-{{ ansible_os_family }}.yml'
  tags: ['install']

- name: Install td-agent-bit.rpm
  # environment:
  #   http_proxy: http://proxy-1.proxy.oal.oraclevcn.com:80
  #   https_proxy: http://proxy-1.proxy.oal.oraclevcn.com:80
  yum:
    name: "https://packages.fluentbit.io/centos/7/x86_64/td-agent-bit-{{td_agent_bit_version}}.x86_64.rpm"
    disable_gpg_check: yes
    state: present

- name: Download osquery rpm
  # environment:
  #   http_proxy: http://proxy-1.proxy.oal.oraclevcn.com:80
  #   https_proxy: http://proxy-1.proxy.oal.oraclevcn.com:80
  get_url:
    url: https://pkg.osquery.io/rpm/osquery-{{osquery_version}}.linux.x86_64.rpm
    dest: /tmp/osquery-{{osquery_version}}.linux.x86_64.rpm

- name: Ensure latest version of packages is installed.
  # environment:
  #   http_proxy: http://proxy-1.proxy.oal.oraclevcn.com:80
  #   https_proxy: http://proxy-1.proxy.oal.oraclevcn.com:80
  yum:
    name: /tmp/osquery-{{osquery_version}}.linux.x86_64.rpm
    state: present
  become: yes

# workaroudn for latest osquery package
- name: Creates /etc/osquery directory
  file:
    path: /etc/osquery
    state: directory

- name: Ensure td-agent-bit Service is enabled and started
  become: true
  service:
    name: td-agent-bit
    enabled: yes 
    state: started
  notify: Restart Fluentbit

- name: Ensure osquery Service is enabled and started Osquery
  become: true
  service:
    name: osqueryd
    enabled: yes
    state: started
  notify: Restart Osquery
  
- import_tasks: configure.yml
